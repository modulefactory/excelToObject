<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="iceberg.capi.order.webdb.repository.ordersheet.OrderSheetDcSqlMapRepository">
	               
	
	
	 <!-- 
		내용	: 일시불할인 정보가 있는지 갯수 체크.
		작성자	: 윤병찬
		작성일	: 2013.11.13 신규작성
		
		#{ecOrdNo} = 61;
	-->
	<select id="findSgpayDcCnt" parameterType="long"  resultType="int">
		<![CDATA[
			 SELECT COUNT(*)
			   FROM GS_ORD_ITEM_PRC_D
			  WHERE EC_ORD_ITEM_NO IN (
			         SELECT GOID.EC_ORD_ITEM_NO
			          FROM GS_ORD_M GOM,
			               GS_ORD_ITEM_D GOID
			         WHERE GOM.EC_ORD_NO = #{ecOrdNo}
			           AND GOM.EC_ORD_ST_CD = 'A'
			           AND GOM.EC_ORD_NO = GOID.EC_ORD_NO
			      )
			  AND ADJST_TYP_CD = 'PA'
			  AND ADJST_DTL_CD = 'A04'
			  AND EC_ORD_ST_CD = 'A'
		 ]]>  
	</select>
	
	
	 <!-- 
		내용	: 일시불 할인여부를 update한다.
		작성자	: 윤병찬
		작성일	: 2013.11.13 신규작성
		
		#{_c.sgpayDcFlg[0].value} = 'Y'
		#{_c.ecOrdNo[0].value} = 61;
	-->
	<update id="updateSgpayDcYn" parameterType="criteria">
		<![CDATA[
			 UPDATE GS_ORD_ITEM_PRC_D
			    SET ADJST_DTL_REP_VAL = #{_c.sgpayDcFlg[0].value}
			  WHERE EC_ORD_ITEM_NO IN (
			         SELECT GOID.EC_ORD_ITEM_NO
			           FROM GS_ORD_M GOM,
			                GS_ORD_ITEM_D GOID
			           WHERE GOM.EC_ORD_NO = #{_c.ecOrdNo[0].value}
			             AND GOM.EC_ORD_NO = GOID.EC_ORD_NO
			         )
			  AND ADJST_TYP_CD = 'PA'
			  AND ADJST_DTL_CD = 'A04'
			  AND EC_ORD_ST_CD = 'A'
		 ]]>  
	</update>	
	
	
	 <!-- 
		내용	: 해당 상품의 즉시적립정보 조회
		작성자	: 윤병찬
		작성일	: 2013.12.02 신규작성
		
		#{_c.prdPrc[0].value} = 10000
		#{_c.prdCd[0].value} = 5528453
	-->
	<resultMap id="prdImmAccmDcInfoMap" type="iceberg.capi.order.model.ordersheet.GsOrdItemDcInfo">
		<result property="immAccDcAmtChar" column="IMM_ACCM_DC_RT_INFO"/>
		<result property="immAccmDcRt" column="IMM_ACCM_DC_RT"/>
		<result property="immAccDcFlg" column="IMM_ACCM_DC_LIMIT_YN"/>
	</resultMap>
	<select id="findPrdImmAccmDcInfo" parameterType="criteria"  resultMap="prdImmAccmDcInfoMap">
		<![CDATA[
			 SELECT PG_PMO_PRD_PMO.FN_PRD_ACCM(ACCM.PRD_CD, 'P', SYSDATE, #{_c.prdPrc[0].value}, 'Y') AS IMM_ACCM_DC_RT_INFO 
			       ,ACCM.IMM_ACCM_DC_RT 			/*적립금액,당사적립금액*/
			       ,ACCM.IMM_ACCM_DC_LIMIT_YN
			   FROM (SELECT CASE WHEN NVL(IMM_ACCM_DC_RT, 0) = 0 
			                     THEN (SELECT TO_NUMBER(VAL) FROM EC_REFSETVAL WHERE REFSETID = 1800 AND CODE = 'A1') 
			                ELSE NVL(IMM_ACCM_DC_RT, 0) END IMM_ACCM_DC_RT 
			               ,PRD_CD
			               ,IMM_ACCM_DC_LIMIT_YN
			           FROM PRD_PRD_M   
			  	       WHERE PRD_CD = #{_c.prdCd[0].value} 
			        )ACCM
		 ]]>  
	</select>	
	
	
	
</mapper>