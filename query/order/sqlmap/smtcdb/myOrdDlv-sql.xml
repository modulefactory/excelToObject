<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="iceberg.capi.order.smtcdb.repository.orderdelivery.OrdDlvSqlMapRepository">

	<!--
		설명 : 내 주문 배송 현황 모델
		작성자 : 유영모
		작성일 : 2013-11-22
		#{_c.custNo[0].value} = 41114755
		#{_c.fromDate[0].value} = '20131206'
		#{_c.toDate[0].value} = '20140106'
	-->
	<resultMap id="myOrdDlv" type="iceberg.capi.order.model.orderdelivery.MyOrdDlv">
		<result property="ordNo"				column="ORD_NO"/>
		<result property="orgOrdNo"				column="ORG_ORD_NO"/>
		<result property="ordDtm"				column="ORD_DTM"/>
		<result property="ordItemNo"			column="ORD_ITEM_NO"/>
		<result property="prdCd"				column="PRD_CD"/>
		<result property="prdNm"				column="PRD_NM"/>
		<result property="qty"					column="QTY"/>
		<result property="approvalPrice"		column="APPROVALPRICE"/>
		<result property="status"				column="STATUS"/>
		<result property="ordType"				column="ORD_TYPE"/>
		<result property="oldClsCd"				column="OLD_CLS_CD"/>
		<result property="xSwProd"				column="X_SW_PROD"/>
		<result property="dlvPickMthodCd"		column="DLV_PICK_MTHOD_CD"/>
		<result property="repPrdSupPrdCd"		column="REP_PRD_SUP_PRD_CD"/>
		<result property="supNo"				column="SUP_CD"/>
		<result property="repPrdSupPrdCd"		column="REP_PRD_SUP_PRD_CD"/>
		<result property="repPrdSupPrdNm"		column="REP_PRD_SUP_PRD_NM"/>
		<result property="delivName"			column="DELIV_NAME"/>
		<result property="ordDlvGrdCd"			column="ORD_DLV_GRD_CD"/>
		<result property="lineTypCd"			column="LINE_TYP_CD"/>
		<result property="realPrice"			column="REALPRICE"/>
		<result property="agentCode"			column="AGENTCODE"/>
		<result property="mimTypCd"				column="MIM_TYP_CD"/>
		<result property="pleinOrdStCd"			column="PLEIN_ORD_ST_CD"/>
		<result property="returnYn"				column="RETURNYN"/>
		<result property="oboxCd"				column="OBOX_CD"/>
		<result property="attrPrdNm"			column="ATTR_PRD_NM"/>
		<result property="rfnTypCd"				column="RFN_TYP_CD"/>
		<result property="arfnDt"				column="ARFN_DT"/>
		<result property="repPrdSupAddCntnt"	column="REP_PRD_SUP_ADD_CNTNT"/>
		<result property="repPrdSupAttrPrdNm"	column="REP_PRD_SUP_ATTR_PRD_NM"/>
		<result property="contactSts"			column="CONTACT_STS"/>
		<result property="statusCdSys"			column="STATUS_CD_SYS"/>
		<result property="ordCnfFlg"			column="ORD_CNF_FLG"/>
		<result property="dlvFshDt"				column="DLV_FSH_DT"/>
		<result property="creditAmt"			column="CREDITAMT"/>
		<result property="juklibFlag"			column="JUKLIBFLAG"/>
		<result property="ordItemId"			column="ORD_ITEM_ID"/>
		<result property="partNum"				column="PART_NUM"/>
		<result property="shipDate"				column="SHIP_DATE"/>
		<result property="totAmt"				column="TOT_AMT"/>
		<result property="ecValidDlvCd"			column="EC_VALID_DLV_CD"/>
		<result property="ecScheduledDelDate"	column="EC_SCHEDULED_DEL_DATE"/>
		<result property="areaLeadTime"			column="AREA_LEAD_TIME"/>
		<result property="optPrdTypCd"			column="OPT_PRD_TYP_CD"/>
		<result property="ecAttrSeq"			column="EC_ATTR_SEQ"/>
		<result property="dittoFlg"				column="DITTO_FLAG"/>
		<result property="supCd"				column="SUPP_NAME"/>
		<result property="charCpnTypCd"			column="CHAR_CPN_TYP_CD"/>
		<result property="rsrvSalePrdFlg"		column="RSRV_SALE_PRD_FLG"/>
		<result property="ordMnfcTypCd"			column="ORD_MNFC_TYP_CD"/>
		<result property="ordMnfcTypNm"			column="ORD_MNFC_TYP_NM"/>
		<result property="chanlDtlCd"			column="CHANL_DTL_CD"/>
		<result property="frmlesPrdTypCd"		column="FRMLES_PRD_TYP_CD"/>	
		<result property="reasonMid"			column="REASONMID"/>	
		<result property="reasonSml"			column="REASONSML"/>	
		<result property="pmoGiftFlag"			column="PMO_GIFT_YN"/>		
	</resultMap>
	
	<!--
		API : 내 주문 배송 현황 목록 조회
		설명 : 주문 배송 현황에서 노출할 내 주문 배송 목록을 조회 한다.
		작성자 : 유영모
		작성일 : 2013-11-22
	-->
    <select id="findMyOrderDeliveryList" parameterType="criteria" resultMap="myOrdDlv">
    <![CDATA[
    SELECT  *
	  FROM  (  
	  	  SELECT ORD_NO
	  	  		,ORG_ORD_NO
	  	  		,ORD_DTM
	  	  		,ORD_ITEM_NO
	  	  		,GOODS_CODE AS PRD_CD
	  	  		,GOODS_NAME AS PRD_NM
	  	  		,QTY
	  	  		,APPROVALPRICE
	  	  		,STATUS
				,ORD_TYPE
				,OLD_CLS_CD
				,X_SW_PROD
				,DLV_PICK_MTHOD_CD
				,SUP_CD
				,REP_PRD_SUP_PRD_CD
				,REP_PRD_SUP_PRD_NM
				,DELIV_NAME
				,ORD_DLV_GRD_CD
				,LINE_TYP_CD
				,REALPRICE
				,AGENTCODE
				,MIM_TYP_CD
				,PLEIN_ORD_ST_CD
				,RETURNYN
				,OBOX_CD
				,ATTR_PRD_NM
				,RFN_TYP_CD
				,ARFN_DT
				,REASONMID
				,REP_PRD_SUP_ADD_CNTNT
				,REP_PRD_SUP_ATTR_PRD_NM
				,CONTACT_STS
				,STATUS_CD_SYS
				,ORD_CNF_FLG
				,DLV_FSH_DT
				,CREDITAMT
				,JUKLIBFLAG
				,ORD_ITEM_ID
				,PART_NUM
				,SHIP_DATE
				,TOT_AMT
				,EC_VALID_DLV_CD
				,EC_SCHEDULED_DEL_DATE
				,AREA_LEAD_TIME
				,OPT_PRD_TYP_CD
				,EC_ATTR_SEQ
				,DITTO_FLAG
				,SUPP_NAME
				,CHAR_CPN_TYP_CD
				,RSRV_SALE_PRD_FLG
				,ORD_MNFC_TYP_CD
				,ORD_MNFC_TYP_NM
				,CHANL_DTL_CD
				,FRMLES_PRD_TYP_CD
				,REASONSML
				,PMO_GIFT_YN
	  	  FROM	( 
		  	SELECT	CASE 	WHEN ORD_TYPE = 'R' AND STATUS IN ('R1','R2','R3') THEN 'Y'
                      WHEN ORD_TYPE = 'E' AND STATUS NOT IN ('11','12','21','22','31','B1') THEN 'Y'
                      ELSE	NVL(EC_EXPOS_EXCPT_FLG, 'N')
		            END  	EC_EXPOS_EXCPT_FLG
		            ,ORD_NO
					,ORG_ORD_NO
					,ORD_DTM
					,ORD_ITEM_NO
					,GOODS_CODE
					,GOODS_NAME
					,QTY
					,APPROVALPRICE
					,STATUS
					,ORD_TYPE
					,OLD_CLS_CD
					,X_SW_PROD
					,DLV_PICK_MTHOD_CD
					,SUP_CD
					,REP_PRD_SUP_PRD_CD
					,REP_PRD_SUP_PRD_NM
					,DELIV_NAME
					,ORD_DLV_GRD_CD
					,LINE_TYP_CD
					,REALPRICE
					,AGENTCODE
					,MIM_TYP_CD
					,SUP_NM
					,PLEIN_ORD_ST_CD
					,PRD_CD
					,RETURNYN
					,OBOX_CD
					,ATTR_PRD_NM
					,RFN_TYP_CD
					,ARFN_DT
					,REASONMID
					,REP_PRD_SUP_ADD_CNTNT
					,REP_PRD_SUP_ATTR_PRD_NM
					,CONTACT_STS
					,STATUS_CD_SYS
					,ORD_CNF_FLG
					,DLV_FSH_DT
					,CREDITAMT
					,JUKLIBFLAG
					,ORD_ITEM_ID
					,PART_NUM
					,SHIP_DATE
					,TOT_AMT
					,EC_VALID_DLV_CD
					,EC_SCHEDULED_DEL_DATE
					,AREA_LEAD_TIME
					,OPT_PRD_TYP_CD
					,EC_ATTR_SEQ
					,DITTO_FLAG
					,SUPP_NAME 
					,CHAR_CPN_TYP_CD
					,RSRV_SALE_PRD_FLG
					,ORD_MNFC_TYP_CD
					,ORD_MNFC_TYP_NM
					,SET_PRD_CD
					,SET_PRD_ORD_SEQ
					,SET_PRD_ORD_SEQ_SEQ
					,SET_PRD_NM
					,SET_DITTO_YN
					,SET_SUP_CD
					,CHANL_DTL_CD
					,FRMLES_PRD_TYP_CD
					,REASONSML
					,PMO_GIFT_YN
		  	  FROM	(	          
		          SELECT  NVL(OID.EC_EXPOS_EXCPT_YN,'N') AS EC_EXPOS_EXCPT_FLG
		  				,OOM.ORD_NO
		                ,OOM.ORG_ORD_NO
		                ,OOM.ORD_DTM
		                ,OID.ORD_ITEM_NO
		                ,DECODE(OID.LINE_TYP_CD, '11', OID.REP_PRD_SUP_PRD_CD, TO_CHAR(PPM.PRD_CD)) AS GOODS_CODE
		                ,CASE WHEN OID.CHANL_CD IN ('P','B') AND OID.LINE_TYP_CD NOT IN ('01','02','06') THEN OID.EXPOS_PRD_NM ELSE OID.PRD_NM END AS GOODS_NAME
		                ,NVL(OID.ORD_QTY, 0) - NVL(OID.RTP_QTY,0) AS QTY
		                ,(NVL(OID.STD_UPRC, 0)
		                  - (FLOOR((NVL(OIPD_A01.SUP_GIV_AMT,0)+NVL(OIPD_A01.GSHS_GIV_AMT,0))/10)*10)) * NVL(OID.ORD_QTY, 0)
		                  + (NVL(OIPD_A14.GSHS_GIV_AMT,0) * NVL(OID.ORD_QTY, 0)) AS SALEPRICE
		                ,NVL(OID.LAST_UPRC, 0) * NVL(OID.ORD_QTY, 0) AS APPROVALPRICE
		                ,CASE WHEN OID.ST_CD IN ('31','B1')
		                       AND OID.DLVS_CO_CD IN ('HJ','DH','HD','HT','CJ','KG','EP','ER','FA','AJ','KL','YC','KR','TR','KT','SD','SG','ND','IN','DS','CI')
		                       AND (SYSDATE - OID.DLV_FSH_DT) < 8
		                       AND OID.DLV_FSH_SUBJ_CD = 'V'
		                       AND (CASE WHEN (TO_NUMBER(TO_CHAR(OID.RELS_FSH_DT,'YYYYMMDD')) < '20081211')
		                                 THEN '3'
		                                 ELSE SUBSTR(OID.DLV_PICK_MTHOD_CD,0,1)
		                                  END
		                           ) = '3'
		                      THEN '22'
		                      ELSE OID.ST_CD END STATUS
		                ,NVL(OID.STD_UPRC,0) * OID.ORD_QTY AS SALEPRICE_TEMP
		                ,NVL(OID.RTP_QTY,0) AS RET_QTY
		                ,OID.CHANL_CD
		                ,DECODE(OOM.ORD_TYP_DTL_CD, 'Sales Order',           'S',
		                                          'Return Order',          'R',
		                                          'Exchange Sales Order',  'E',
		                                          'Exchange Return Order', 'R',
		                                          'AS Remove',             'A',
		                                          'AS Delivery',           'A',
		                                          'AS Not Remove',         'A',
		                                          'AS Not Delivery',       'A',
		                                          'AS Visit',              'A',
		                                          'Virtual Sales',         'S',    'R'
		                 ) AS ORD_TYPE
		                ,X.OLD_CLS_CD
		                ,PPM.FRMLES_PRD_TYP_CD AS X_SW_PROD
		                ,OID.DLV_PICK_MTHOD_CD
		                ,OID.SUP_CD
		                ,CCAD.RCVR_NM
		                ,OID.REP_PRD_SUP_PRD_CD
		                ,OID.REP_PRD_SUP_PRD_NM
		                ,FLOOR(((NVL(OID.STD_UPRC, 0) - (NVL(OIPD_A01.SUP_GIV_AMT,0)+NVL(OIPD_A01.GSHS_GIV_AMT,0))))/10) * 10 * NVL(OID.ORD_QTY, 0)
		                  + (NVL(OIPD_A14.GSHS_GIV_AMT,0) * NVL(OID.ORD_QTY, 0)) AS PRESALEPRICE
		                ,SIGN(TO_DATE(TO_CHAR(OID.DLV_FSH_DT, 'YYYYMMDD'), 'YYYYMMDD')
		                    - TO_DATE(TO_CHAR(SYSDATE-30, 'YYYYMMDD'), 'YYYYMMDD')) AS GB_FLAG
		                ,'' AS LOGIN_ID 
		                ,'' AS STATUS_MP
		                ,'' AS SELL_ECUSERID
		                ,'' AS MP_SUPP_CODE
		                ,NVL(TO_CHAR(OOM.TMP_ORD_NO),'') AS ORDID
		                ,'N' AS ORD_CONFIRM_YN
		                ,'N' AS CCL_ORD_REQ_YN
		                ,CCC.CD_VAL AS DELIV_NAME
		                ,OID.ORD_DLV_GRD_CD
		                ,PCM.PRD_CLS_CD 
		                ,OID.LINE_TYP_CD
		                ,NVL(OID.LAST_UPRC, 0) * NVL(OID.ORD_QTY, 0) AS REALPRICE
		                ,CCC.CMM_CD AS AGENTCODE
		                ,SSM.MIM_TYP_CD
		                ,SSM.SUP_NM
		                ,SSM.ASIGNR_TELNO_1
		                ,OID.PLEIN_ORD_ST_CD
		                ,PPM.PRD_CD         /* 반품교환신청 버튼 노출 시 사용하는데 반품기일 고려하도록 수정
		               ,CASE WHEN (OID.ST_CD = '22') AND SYSDATE < (OID.RELS_FSH_DT + 37) THEN 'Y'
		                      WHEN (OID.ST_CD = '31' OR OID.ST_CD = 'B1') AND SYSDATE < (OID.DLV_FSH_DT + 31) THEN 'Y'
		                      ELSE 'N' END RETURNYN	*/
		                ,CASE WHEN NVL(PPM.FRMLES_PRD_TYP_CD, 'N') = 'R' THEN                                  /*무형상품코드 = 문자쿠폰(상품교환권)*/
		                           CASE WHEN (OID.ST_CD = '22')
		                              AND SYSDATE < (OID.RELS_FSH_DT + 7)
		                                     THEN 'Y'                              /* +9/24 */
		                                WHEN (OID.ST_CD = '31' OR OID.ST_CD = 'B1') AND SYSDATE < (OID.DLV_FSH_DT + 7) THEN 'Y'             /* +9/24 */
		                                ELSE 'N'
		                                END
		                      WHEN NVL(PPM.FRMLES_PRD_TYP_CD, 'N') <> 'R' THEN		/* 신세계 상품 출고완료+13일/ 배송완료+7일 */
		                      	   CASE WHEN (OID.ST_CD = '22') AND OID.SUP_CD = 1020882 AND SYSDATE < (OID.RELS_FSH_DT + 14)
		                      	   			THEN 'Y'
		                      	   		WHEN (OID.ST_CD = '31' OR OID.ST_CD = 'B1') AND OID.SUP_CD = 1020882
		                      	   				AND SYSDATE < (OID.DLV_FSH_DT + 8)
		                      	   			THEN 'Y'
		                           		WHEN (OID.ST_CD = '22') AND OID.SUP_CD <> 1020882 AND SYSDATE < (OID.RELS_FSH_DT + NVL(PCSD.RTP_TERM_DDCNT, 30) + 7)
		                                	THEN 'Y'                                                                                      /* +9/24 */
		                                WHEN (OID.ST_CD = '31' OR OID.ST_CD = 'B1') AND OID.SUP_CD <> 1020882
		                                 		AND SYSDATE < (OID.DLV_FSH_DT + NVL(PCSD.RTP_TERM_DDCNT, 30) + 1)
		                                	THEN 'Y'                                                                                      /* +9/24 */
		                                ELSE 'N'
		                           END
		                      ELSE 'N'
		                      END RETURNYN
		                ,OID.SHTPRD_ACCM_GIV_CD
		                ,OID.OBOX_CD
		                ,NVL(OID.ATTR_PRD_NM, '') AS ATTR_PRD_NM
		                ,OID.RFN_TYP_CD
		                ,OID.ARFN_TIME_CD
		                ,OID.ARFN_DT
		                ,X.X_REASON_MID AS REASONMID
		                ,OID.REP_PRD_SUP_ADD_CNTNT
		                ,OID.REP_PRD_SUP_ATTR_PRD_NM
		                ,NVL(OIPD_A12.GSHS_GIV_AMT, 0) AS ONEBOXSALEPRICE
		                ,DECODE(SIGN(OOM.ORD_DTM - X.X_CREATED), -1, X.X_CREATED, OOM.ORD_DTM) AS ORDRR_DATE
		                ,'CY' AS  CONTACT_STS
		                ,CASE WHEN (OID.RELS_FSH_DT < TO_DATE('20081211000000','YYYYMMDDHH24MISS')) THEN 'XX' ELSE OID.DIRDLV_OBOX_DLV_ST_CD END AS STATUS_CD_SYS
		                ,NVL(OOM.ORD_CNF_YN, 'N') AS ORD_CNF_FLG
		                ,TO_CHAR(OID.DLV_FSH_DT, 'YYYYMMDD') AS DLV_FSH_DT
		                ,CCAD.BASE_ADDR || ' ' || CCAD.DTL_ADDR AS RECEIVER_ADDR
		                ,FLOOR(DECODE(NVL(OID.ORD_QTY, 0), 0, 0, (NVL(OID.ACCM_GIV_TOT_AMT, 0) / OID.ORD_QTY) *(OID.ORD_QTY - NVL(OID.RTP_QTY, 0)))) AS CREDITAMT
		                ,DECODE(NVL(CCADTD.DOWN_YN,'Y'),'N',DECODE(SIGN(TRUNC(SYSDATE - OID.RELS_FSH_DT) - 100), 1, 'X', 'N'), 'Y') AS JUKLIBFLAG
		                ,OID.ORD_ITEM_ID
		                ,DECODE(OID.LINE_TYP_CD, '11', OID.REP_PRD_SUP_PRD_CD, PPM.PRD_CD) AS PART_NUM
		                ,(CASE WHEN OID.RELS_FSH_DT IS NULL THEN '' ELSE TO_CHAR(OID.RELS_FSH_DT, 'YYYYMMDDHH24MISS') END) AS SHIP_DATE
		                ,NVL(OID.LAST_UPRC,0) * OID.ORD_QTY AS TOT_AMT
		                ,OID.EC_VALID_DLV_CD
		                ,TO_CHAR(DECODE(OID.TH2_DLV_SCHD_DT,NULL,OID.DLV_PLAN_DT,OID.TH2_DLV_SCHD_DT), 'YYYYMMDDHH') AS EC_SCHEDULED_DEL_DATE
		                ,(SELECT DLV_REQUIR_TIME_VAL/24
		                    FROM CMM_ZIPCD_DLV_C
		                   WHERE ZIPCD = (SELECT  ZIPCD
		                                    FROM  CST_CUST_ADDR_D
		                                   WHERE  NVL(ADDR_USE_YN, 'Y') != 'N'
		                                     AND  ADDR_CNTC_NO = OID.DLVP_ADDR_NO
		                                     AND  ROWNUM < 2)
		                     AND ROWNUM < 2) AS AREA_LEAD_TIME
		                ,OID.OPT_PRD_TYP_CD
		                ,TO_CHAR(OID.EC_ATTR_SEQ) AS EC_ATTR_SEQ
		                ,TO_CHAR(PAPM.ATTR_PRD_CD) AS ATTR_PRD_CD
		                ,NVL(PPM.DITTO_YN, 'N') AS DITTO_FLAG
		                ,TO_CHAR(SSM.SUP_CD) AS SUPP_NAME
		                ,OID.CHAR_CPN_RCVR_TELNO AS CHAR_CPN_RCVR_TELNO
		                ,NVL(OID.CHAR_CPN_TYP_CD, 'XXX') AS CHAR_CPN_TYP_CD
		                ,NVL(OID.RSRV_SALE_PRD_YN, 'N') AS RSRV_SALE_PRD_FLG
		                ,OID.ORD_MNFC_TYP_CD AS ORD_MNFC_TYP_CD
		                ,(SELECT CD_VAL FROM CMM_CMM_C WHERE CMM_GRP_CD = 'PRD094' AND CMM_CD = OID.ORD_MNFC_TYP_CD) AS ORD_MNFC_TYP_NM
		                ,NVL(OID.SET_PRD_CD,0) AS SET_PRD_CD
		                ,CASE WHEN NVL(OID.SET_PRD_CD,0) = 0 OR OID.LINE_TYP_CD IN ('01', '02', '06', '07') THEN 0 ELSE NVL(OID.SET_PRD_ORD_SEQ,0) END AS SET_PRD_ORD_SEQ
						,CASE WHEN NVL(OID.SET_PRD_CD,0) = 0 OR OID.LINE_TYP_CD IN ('01', '02', '06', '07') THEN 0
		                      ELSE ROW_NUMBER () OVER(PARTITION BY OID.ORD_NO ORDER BY OID.LINE_TYP_CD, NVL(OID.SET_PRD_CD, 0), NVL(OID.SET_PRD_ORD_SEQ,0), OID.ORD_ITEM_NO)
					          END AS SET_PRD_ORD_SEQ_SEQ
		                ,OID.SET_PRD_NM
						,CASE WHEN NVL(OID.SET_PRD_CD,0) > 0
						      THEN (SELECT  NVL(DITTO_YN, 'N')
						              FROM  PRD_PRD_M
									 WHERE  PRD_CD = OID.SET_PRD_CD
								   )
							  ELSE 'N' END AS SET_DITTO_YN
						,CASE WHEN NVL(OID.SET_PRD_CD,0) > 0
						      THEN (SELECT  TO_CHAR(SUP_CD)
						              FROM  PRD_PRD_M
									 WHERE  PRD_CD = OID.SET_PRD_CD
								   )
							  ELSE '' END AS SET_SUP_CD
						,CASE WHEN OID.LINE_TYP_CD IN ('01', '02', '06')
						       AND OID.MULTI_SIMPL_GBN_CD IS NOT NULL
						       AND NVL(OID.GFT_MAND_YN,'N') = 'N'
						       AND OID.ST_CD IN ('11', '12', '21')
						      THEN 'Y' ELSE 'N' END AS PMO_GIFT_YN
						,PPM.PRD_TYP_CD
						,OID.CHANL_DTL_CD
						,NVL(PPM.FRMLES_PRD_TYP_CD, 'N') AS FRMLES_PRD_TYP_CD
						,X.X_REASON_SML AS REASONSML
		           FROM  ORD_ORD_M OOM
		                ,ORD_ITEM_D OID
		                ,ORD_ITEM_PRC_D OIPD_A01
		                ,ORD_ITEM_PRC_D OIPD_A12
		                ,ORD_ITEM_PRC_D OIPD_A14
		                ,PRD_PRD_M PPM
		                ,CST_CUST_ADDR_D CCAD
		                ,(SELECT  SSM.ORD_ITEM_ID AS X_ORDER_ITEM_ID
		                         ,MAX(SSM.ACP_DTM) X_CREATED
		                         ,MAX(SSCC.OLD_CLS_CD) OLD_CLS_CD 
		                         ,MAX(SSM.SR_RSN_MID_CLS_CD) X_REASON_MID
		                         ,MAX(SSM.SR_RSN_SML_CLS_CD) X_REASON_SML 
		                    FROM  SRV_SR_M SSM
		                         ,SRV_SR_CLS_C SSCC
		                   WHERE  SSM.SR_RSN_SML_CLS_CD = SSCC.SR_RSN_CLS_CD(+)
		                     AND  SSCC.SR_RSN_CLS_TYP_CD(+) = 'SR'
		                     AND  SSM.CUST_NO = #{_c.custNo[0].value}
		                     AND  SSCC.OLD_CLS_CD(+) IN ('I02', 'I03', 'I04', 'C07')
		                     AND  NVL(SSM.SR_PROC_ST_CD, 'Closed') = 'Open'
		                   GROUP  BY SSM.ORD_ITEM_ID
		                 ) X
		                ,CMM_CMM_C CCC
		                ,PRD_CLS_M PCM				  /* 상품분류기본 */
		                ,PRD_CLS_SET_D PCSD            /* 상품분류설정정보 */
		                ,SUP_SUP_M SSM
		                ,PRD_ATTR_PRD_M PAPM
		                ,CST_CUST_ACCM_DOWN_TGT_D CCADTD
		          WHERE  OOM.CUST_NO                = #{_c.custNo[0].value} 
		          ]]>
				  <choose>
				  	<when test='_c.fromDate != null and _c.fromDate[0].value != "" and _c.toDate != null and _c.toDate[0].value != ""'>
		          		  AND OOM.ORD_DTM BETWEEN TO_DATE(#{_c.fromDate[0].value},'YYYYMMDD') AND TO_DATE(#{_c.toDate[0].value}||'235959','YYYYMMDDHH24MISS')
				  	</when>
				  	<otherwise>
				  		<if test='_c.dateFlag != null and _c.dateFlag[0].value != ""'>
				  			<choose>
				  				<when test="@org.apache.commons.lang.StringUtils@length(_c.dateFlag[0].value) == 6">
				  		  AND OOM.ORD_DTM BETWEEN TO_DATE(#{_c.dateFlag[0].value}||'01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(#{_c.dateFlag[0].value}||'01', 'YYYYMMDD')) +0.99999
				  				</when>
				  				<otherwise>
				  		  AND OOM.ORD_DTM >= TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE, TO_NUMBER(#{_c.dateFlag[0].value})),'YYYYMMDD'),'YYYYMMDD')
				  				</otherwise>
				  			</choose>
				  		</if>
				  	</otherwise>
				  </choose>	  
		            	  AND  OOM.ORD_NO                 = OID.ORD_NO
		                  AND OOM.ORD_TYP_DTL_CD NOT IN ('AS Remove', 'AS Delivery', 'AS Not Remove', 'AS Not Delivery'
		                  		, 'AS Visit', 'eStore Order','Exchange Return Order','Exchange Return Order')
		                  /* 00 반품접수중, A1 주문작업중, 41 주문접수후 취소, 49 전산자동취소*/
		                  AND RTRIM(OID.ST_CD) NOT IN ('00', 'A1', '41', '49') 
		            	  /* 전량반품된 경우 보여주지 않기 20080212 added by yeedh*/
		            	  AND NVL(OID.ORD_QTY, 0) - NVL(OID.RTP_QTY,0) > 0   
		            	  
		            	  /* 회원주문인지 비회원주문인지 구분(S_ORDER_X.X_NOMEM_ORD_FLG : 'Y' 이면 비회원주문, 그 외 회원주문) */
            	  <choose>
            	  	<when test="_c.isNoMemOrd[0].value == true">
            	  		  AND OOM.EC_NOMEM_ORD_YN = 'Y'
            	  		<if test='_c.dlvTelNo != null and _c.dlvTelNo[0].value != ""'>
            	  		  AND (REPLACE(CCAD.DLVP_TELNO, '-') = #{_c.dlvTelNo[0].value}
            	  		  			OR REPLACE(CCAD.DLVP_CELPHN_TELNO, '-') =  #{_c.dlvTelNo[0].value})
            	  		</if>
            	  	</when>
            	  	<otherwise>
            	  	 <![CDATA[
            	  		  AND NVL(OOM.EC_NOMEM_ORD_YN, 'N') <> 'Y'
            	     ]]>
            	  	</otherwise>
            	  </choose>
		           <![CDATA[   
			            AND  NVL(OID.LINE_TYP_CD, '00') <> '07'
			            AND  OID.PRD_CD                 = PPM.PRD_CD(+)
			            AND  OID.ORD_ITEM_ID            = OIPD_A01.ORD_ITEM_ID(+)
			            AND  OID.ORD_ITEM_ID            = OIPD_A12.ORD_ITEM_ID(+)
			            AND  OID.ORD_ITEM_ID            = OIPD_A14.ORD_ITEM_ID(+)
			            AND  OIPD_A01.ADJST_DTL_CD(+)  = 'A01'
			            AND  OIPD_A12.ADJST_DTL_CD(+)  = 'A12'
			            AND  OIPD_A14.ADJST_DTL_CD(+)  = 'A14'
			            AND  OID.ORD_ITEM_ID            = X.X_ORDER_ITEM_ID(+)
			            AND  OID.DLVP_ADDR_NO           = CCAD.ADDR_CNTC_NO(+)
			            AND  CCC.CMM_GRP_CD(+)          = 'PRD008'
			            AND  CCC.USE_YN(+)              = 'Y'
			            AND  OID.DLVS_CO_CD             = CCC.CMM_CD(+)
			            AND  NVL(OID.EC_EXPOS_EXCPT_YN,'N') <> 'Y'
			            AND  PPM.PRD_CLS_CD             = PCM.PRD_CLS_CD
			            AND  SUBSTR(PCM.PRD_CLS_CD,1,7)  = PCSD.PRD_CLS_CD
			            AND  PCSD.CLS_SET_CD = 'R'
			            AND  NVL(OOM.CHANL_CD, 'P') <> 'S' 
			            AND  ( (OOM.CHANL_CD = 'P' AND PCSD.CHANL_OR_GRP_CD = (SELECT CHANL_GRP_CD from PRD_CHANL_MAPPN_D
			                                                                 WHERE  CHANL_CD = 'P'
			                                                                 AND    CHANL_GRP_TYP_CD = 'D'
			                                                                 AND    ROWNUM = 1
			                                                                 )
			                     )
			                     OR
			                    (OOM.CHANL_CD != 'P' AND PCSD.CHANL_OR_GRP_CD != (SELECT CHANL_GRP_CD from PRD_CHANL_MAPPN_D
			                                                                 WHERE  CHANL_CD = 'P'
			                                                                 AND    CHANL_GRP_TYP_CD = 'D'
			                                                                 AND    ROWNUM = 1
			                                                                 )
			                     )
			                  )
			            AND  OID.SUP_CD                 = SSM.SUP_CD(+)
			            AND  NVL(OID.CHANL_DTL_CD,'N') NOT IN ('HE')
			            AND  SSM.SUP_CD NOT IN ('1012691','1012768','1012769','1012771')
			            AND  OID.ATTR_PRD_CD  = PAPM.ATTR_PRD_CD(+)
			            AND  OID.ORD_ITEM_ID = CCADTD.ORD_ITEM_ID(+)
			            AND  (CCADTD.TXN_RSN_CD(+) IS NULL OR CCADTD.TXN_RSN_CD(+) <> 'B16')					/* 수입대행 차액정산 건 제외 안하면 동일아이템 중복노출 */
				)
			)
			WHERE	EC_EXPOS_EXCPT_FLG <> 'Y'				/* 수입대행 차액정산 건 제외 안하면 동일아이템 중복노출 */
	        UNION   ALL
	    	SELECT  ORPRD.RSRV_NO
	                ,0
	                ,ORPRD.RSRV_DTM
	                ,0
	                ,TO_CHAR(ORPRD.PRD_CD)
	                ,(CASE WHEN PNCH.EXPOS_PRD_NM IS NULL THEN PPM.PRD_NM ELSE PNCH.EXPOS_PRD_NM END) AS GOODS_NAME
	                ,1
	                ,NVL(ORPRD.SALE_PRC,0)
	                ,ORPRD.CUST_REACT_CD AS STATUS
	                ,'L' AS ORD_TYPE /* 주문 유형(ORD_TYPE) L = 렌탈 상품 상담 내역 */
	                ,''
	                ,''
	                ,''
	                ,ORPRD.SUP_CD AS VENDORCODE
	                ,''
	                ,''
	                ,''
	                ,''
	                ,''
	                ,ORPRD.SALE_PRC
	                ,''
	                ,''
	                ,''
	                ,''
	                ,''
	                ,'' AS ATTR_PRD_NM
	                ,''
	                ,SYSDATE
	                ,''
	                ,''
	                ,''
	                ,'CX' AS CONTACT_STS
	                ,'D' AS STATUS_CD_SYS
	                ,''
	                ,''
	                ,0
	                ,''
	                ,''
	                ,''
	                ,'' AS SHIP_DATE
	                ,0
	                ,''
	                ,'' AS EC_SCHEDULED_DEL_DATE
	                ,0
	                ,''
	                ,''
	                ,'' AS DITTO_FLAG
	                ,'' AS SUPP_NAME
	                ,'' AS MUNJA_COUPON_TYPE
	                ,'' AS RESERVE_SALE_YN
	                ,'' AS X_ORDER_TYPE
	                ,'' AS X_ORDER_TYPE_NAME
					,'REN' AS CHANL_DTL_CD
					,'N' AS FRMLES_PRD_TYP_CD     
					,''   
					,'N' AS PMO_GIFT_YN
	          FROM  ORD_RENT_PRD_RSRV_D ORPRD
	                ,PRD_PRD_M PPM 
	                ,PRD_NM_CHG_H PNCH
	          WHERE  ORPRD.CUST_NO = #{_c.custNo[0].value}
	            AND  ORPRD.PRD_CD = PPM.PRD_CD
	            AND  ORPRD.RSRV_NO IS NOT NULL
	            AND  PPM.PRD_CD = PNCH.PRD_CD
				AND  PNCH.CHANL_CD = 'P'
				AND  PNCH.VALID_END_DTM >= SYSDATE
				AND  PNCH.VALID_STR_DTM <= SYSDATE
				]]>	
	            <choose>
				  	<when test='_c.fromDate != null and _c.fromDate[0].value != "" and _c.toDate != null and _c.toDate[0].value != ""'>
		          		  AND ORPRD.RSRV_DTM BETWEEN TO_DATE(#{_c.fromDate[0].value},'YYYYMMDD') AND TO_DATE(#{_c.toDate[0].value}||'235959','YYYYMMDDHH24MISS')
				  	</when>
				  	<otherwise>
				  		<if test='_c.dateFlag != null and _c.dateFlag[0].value != ""'>
				  			<choose>
				  				<when test="@org.apache.commons.lang.StringUtils@length(_c.dateFlag[0].value) == 6">
				  		  AND ORPRD.RSRV_DTM BETWEEN TO_DATE(#{_c.dateFlag[0].value}||'01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(#{_c.dateFlag[0].value}||'01', 'YYYYMMDD')) +0.99999 
				  				</when>
				  				<otherwise>
				  		  AND ORPRD.RSRV_DTM >= TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE, TO_NUMBER(#{_c.dateFlag[0].value})),'YYYYMMDD'),'YYYYMMDD')
				  				</otherwise>
				  			</choose>
				  		</if>
				  	</otherwise>
				</choose>
	        ) A  
	        ORDER BY A.ORD_DTM DESC, A.LINE_TYP_CD, A.ORD_ITEM_NO, A.OPT_PRD_TYP_CD DESC, A.EC_ATTR_SEQ DESC
	        
	</select>
</mapper>